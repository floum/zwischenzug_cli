#!/usr/bin/env ruby

require 'thor'
require 'zwischenzug_cli'
require 'yaml'

module ZwischenzugCLI
  class CLI < Thor
    desc 'puzzle FEN', 'determines if FEN may be a puzzle'
    def puzzle(fen)
      p Analysis.run(fen)
    end

    desc 'fetch ID', 'fetch puzzle ID from lichess.org'
    option :format, default: 'yaml'
    def fetch(id)
      Lichess.fetch(id, options)
    end

    desc 'load FILE', 'load file to zwischenzug api'
    option :host, default: 'localhost'
    option :port, default: '3000'
    option :username, aliases: ['-u']
    option :password, aliases: ['-p']
    def load(file)
      api_options = {}
      api_options[:username] = options.fetch(:username) { ENV.fetch('ZWISCHENZUG_USER') }
      api_options[:password] = options.fetch(:password) { ENV.fetch('ZWISCHENZUG_PASSWORD') }
      api_options[:host] = options[:host]
      api_options[:port] = options[:port]

      puzzles_map = YAML.load_file(file)
      
      api = ZwischenzugAPI.new(api_options)
      puzzles_map['puzzles'].each do |puzzle|
        api.create(puzzle)
      end
    end
  end
end

ZwischenzugCLI::CLI.start(ARGV)
